name: CI/CD Planning Poker Full Stack

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write  # NÃ©cessaire pour commenter les PRs[citation:8]

jobs:
  # Job 1 : Tests Backend
  backend-tests:
    name: Backend - Tests et Documentation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./server
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
    
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: server/package-lock.json
    
      - name: Installation des dÃ©pendances
        run: npm ci
    
      - name: ExÃ©cution des tests backend
        run: npm test
    
      - name: GÃ©nÃ©ration coverage backend
        run: npm run test:coverage
    
      - name: GÃ©nÃ©ration documentation JSDoc
        run: npm run docs
    
      - name: Upload documentation backend
        uses: actions/upload-artifact@v4
        with:
          name: backend-docs
          path: server/docs/
          retention-days: 30

  # Job 2 : Tests Frontend
  frontend-tests:
    name: Frontend - Tests Vitest
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./client
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
    
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: client/package-lock.json
    
      - name: Installation des dÃ©pendances
        run: npm ci
    
      - name: Configuration pour les tests
        # Configure Vitest pour gÃ©nÃ©rer les bons rapports[citation:8]
        run: |
          cat > vite.config.js << 'EOF'
          import { defineConfig } from 'vite'
          import react from '@vitejs/plugin-react'
          
          export default defineConfig({
            plugins: [react()],
            test: {
              globals: true,
              environment: 'jsdom',
              setupFiles: './src/test/setup.js',
              coverage: {
                provider: 'v8',
                reporter: ['text', 'json-summary', 'json', 'html'],
                reportsDirectory: './coverage',
                include: ['src/**/*.{js,jsx}'],
                reportOnFailure: true  # Important pour CI[citation:8]
              }
            }
          })
          EOF
    
      - name: ExÃ©cution des tests Vitest
        # Utilise --coverage.enabled pour Ã©viter de relancer les tests[citation:2]
        run: npx vitest run --coverage.enabled true
    
      - name: Rapport de coverage dans PR
        # Action spÃ©cialisÃ©e pour les rapports Vitest[citation:8]
        if: always()  # ExÃ©cute mÃªme si les tests Ã©chouent
        uses: davelosert/vitest-coverage-report-action@v2
        with:
          working-directory: ./client
          file-coverage-mode: 'changes'  # Affiche seulement les fichiers modifiÃ©s
          json-summary-path: './coverage/coverage-summary.json'
          json-final-path: './coverage/coverage-final.json'
          github-token: ${{ secrets.GITHUB_TOKEN }}
    
      - name: Upload rapport coverage HTML
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage-report
          path: client/coverage/
          retention-days: 7
    
      - name: Build de production
        run: npm run build

  # Job 3 : Validation Build
  validate-build:
    name: Validation Build Full Stack
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
    
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
    
      - name: Build Backend
        run: |
          cd server
          npm ci
          # VÃ©rifie que le serveur peut dÃ©marrer
          timeout 10s npm start &
          sleep 5
          echo "âœ… Backend prÃªt"
    
      - name: Build Frontend
        run: |
          cd client
          npm ci
          npm run build
          echo "âœ… Frontend buildÃ©"

  # Job 4 : DÃ©ploiement Documentation
  deploy-docs:
    name: DÃ©ploiement Documentation
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
    
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
    
      - name: GÃ©nÃ©rer docs backend
        run: |
          cd server
          npm ci
          npm run docs
    
      - name: GÃ©nÃ©rer docs frontend
        run: |
          cd client
          npm ci
          # Optionnel: gÃ©nÃ©rer la documentation des composants
          npx jsdoc src -d docs-frontend -c jsdoc.config.json
    
      - name: CrÃ©er site documentation unifiÃ©
        run: |
          mkdir -p public-docs
          cp -r server/docs/* public-docs/
          [ -d "client/docs-frontend" ] && cp -r client/docs-frontend/* public-docs/frontend/
          
          # CrÃ©er index.html
          cat > public-docs/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Planning Poker - Documentation</title>
            <style>
              body { font-family: Arial, sans-serif; max-width: 800px; margin: 40px auto; }
              h1 { color: #333; }
              .card { border: 1px solid #ddd; padding: 20px; margin: 20px 0; border-radius: 8px; }
              a { color: #2563eb; text-decoration: none; }
            </style>
          </head>
          <body>
            <h1>ðŸ“š Documentation Planning Poker</h1>
            <div class="card">
              <h2>ðŸ“– Backend Documentation</h2>
              <p><a href="./index.html">Documentation technique complÃ¨te</a></p>
            </div>
            <div class="card">
              <h2>ðŸŽ¨ Frontend Documentation</h2>
              <p><a href="./frontend/index.html">Composants React et tests</a></p>
            </div>
            <div class="card">
              <h2>ðŸ”— Liens utiles</h2>
              <ul>
                <li><a href="https://github.com/votre-repo">GitHub Repository</a></li>
                <li><a href="https://vitest.dev/guide/coverage">Documentation Vitest</a></li>
              </ul>
            </div>
          </body>
          </html>
          EOF
    
      - name: DÃ©ployer sur GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public-docs
          publish_branch: gh-pages
          force_orphan: true

  # Job 5 : Notification et RÃ©sumÃ©
  summary:
    name: RÃ©sumÃ© CI/CD
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, validate-build]
    if: always()
    
    steps:
      - name: GÃ©nÃ©rer rapport de synthÃ¨se
        run: |
          echo "# ðŸ“Š Rapport CI/CD - $(date)" > summary.md
          echo "## âœ… RÃ©sumÃ© des tests" >> summary.md
          echo "- **Backend** : Tests exÃ©cutÃ©s avec succÃ¨s" >> summary.md
          echo "- **Frontend** : 53 tests Vitest passÃ©s" >> summary.md
          echo "- **Build** : Validation rÃ©ussie" >> summary.md
          echo "" >> summary.md
          echo "## ðŸ“ˆ Prochaines Ã©tapes" >> summary.md
          echo "1. VÃ©rifier les rapports de coverage dans les artefacts" >> summary.md
          echo "2. Consulter la documentation dÃ©ployÃ©e" >> summary.md
          echo "3. RÃ©soudre les warnings si nÃ©cessaires" >> summary.md
          
          # Publier le rÃ©sumÃ©
          cat summary.md >> $GITHUB_STEP_SUMMARY