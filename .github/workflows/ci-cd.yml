name: CI-CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # Job 1 : Tests et Documentation Backend
  backend-tests:
    name: Backend - Tests et Documentation
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: Checkout du code
      uses: actions/checkout@v4
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: server/package-lock.json
    
    - name: Installation des dependances
      working-directory: ./server
      run: npm ci
    
    - name: Linter (ESLint)
      working-directory: ./server
      run: npm run lint --if-present
      continue-on-error: true
    
    - name: Execution des tests
      working-directory: ./server
      run: npm test
    
    - name: Generation du coverage
      working-directory: ./server
      run: npm run test:coverage
    
    - name: Upload du rapport de coverage
      uses: codecov/codecov-action@v3
      with:
        files: ./server/coverage/coverage-final.json
        flags: backend
        name: backend-coverage
    
    - name: Generation de la documentation JSDoc
      working-directory: ./server
      run: npm run docs
    
    - name: Upload de la documentation
      uses: actions/upload-artifact@v4
      with:
        name: backend-docs
        path: server/docs/
        retention-days: 30
        overwrite: true

  # Job 2 : Tests Frontend
  # frontend-tests:
  #   name: Frontend - Tests
  #   runs-on: ubuntu-latest
  #   
  #   strategy:
  #     matrix:
  #       node-version: [18.x, 20.x]
  #   
  #   steps:
  #   - name: Checkout du code
  #     uses: actions/checkout@v4
  #   
  #   - name: Setup Node.js ${{ matrix.node-version }}
  #     uses: actions/setup-node@v4
  #     with:
  #       node-version: ${{ matrix.node-version }}
  #       cache: 'npm'
  #       cache-dependency-path: client/package-lock.json
  #   
  #   - name: Installation des dependances
  #     working-directory: ./client
  #     run: npm ci
  #   
  #   - name: Linter (ESLint)
  #     working-directory: ./client
  #     run: npm run lint --if-present
  #     continue-on-error: true
  #   
  #   - name: Execution des tests
  #     working-directory: ./client
  #     run: npm test -- --watchAll=false
  #     env:
  #       CI: true
  #   
  #   - name: Build de production
  #     working-directory: ./client
  #     run: npm run build

  # Job 3 : Qualit√© du code
  code-quality:
    name: Analyse de la qualite du code
    runs-on: ubuntu-latest
    needs: [backend-tests]
    
    steps:
    - name: Checkout du code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Installation Backend
      working-directory: ./server
      run: npm ci
    
    - name: Coverage Backend
      working-directory: ./server
      run: npm run test:coverage
    
    - name: Verification que le fichier existe
      working-directory: ./server
      run: |
        echo "=== Verification du dossier coverage ==="
        ls -la coverage/ || echo "Dossier coverage non trouve"
        echo ""
        echo "=== Contenu du fichier coverage-summary.json ==="
        cat coverage/coverage-summary.json || echo "Fichier non trouve"
    
    - name: Verification seuil de coverage
      working-directory: ./server
      run: |
        if [ ! -f ./coverage/coverage-summary.json ]; then
          echo "Erreur: Le fichier coverage-summary.json n'existe pas"
          exit 1
        fi
        COVERAGE=$(node -e "const c=require('./coverage/coverage-summary.json'); console.log(c.total.lines.pct)")
        echo "Coverage actuel: $COVERAGE%"
        THRESHOLD=15
        if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
          echo " Coverage trop bas! Minimum requis: ${THRESHOLD}%"
          exit 1
        fi
        echo " Coverage OK: $COVERAGE% (minimum: ${THRESHOLD}%)"

  # Job 4 : Deploiement documentation (GitHub Pages)
  deploy-docs:
    name: Deploiement de la documentation
    runs-on: ubuntu-latest
    needs: [backend-tests]
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - name: Checkout du code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Installation des dependances
      working-directory: ./server
      run: npm ci
    
    - name: Generation de la documentation
      working-directory: ./server
      run: npm run docs
    
    - name: Deploiement sur GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./server/docs
        publish_branch: gh-pages
        force_orphan: true

  # Job 5 : Notification de succes
  notification:
    name: Notification
    runs-on: ubuntu-latest
    needs: [backend-tests, code-quality]
    if: always()
    
    steps:
    - name: Status du pipeline
      run: |
        if [ "${{ needs.backend-tests.result }}" == "success" ] && \
           [ "${{ needs.code-quality.result }}" == "success" ]; then
          echo " Pipeline CI/CD reussie!"
        else
          echo " Pipeline CI/CD echouee!"
          exit 1
        fi