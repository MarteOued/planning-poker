name: CI/CD Planning Poker Full Stack

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write

jobs:
  # ============================================
  # JOB 1 : TESTS BACKEND
  # ============================================
  backend-tests:
    name: Backend - Tests et Documentation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./server
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
    
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: server/package-lock.json
    
      - name: Installation des dÃ©pendances
        run: npm ci
    
      - name: ExÃ©cution des tests backend
        run: npm test
    
      - name: GÃ©nÃ©ration coverage backend
        run: npm run test:coverage
    
      - name: GÃ©nÃ©ration documentation JSDoc
        run: npm run docs
    
      - name: Upload documentation backend
        uses: actions/upload-artifact@v4
        with:
          name: backend-docs-${{ matrix.node-version }}
          path: server/docs/
          retention-days: 30
          overwrite: true

  # ============================================
  # JOB 2 : TESTS FRONTEND (CORRIGÃ‰)
  # ============================================
  frontend-tests:
    name: Frontend - Tests Vitest
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./client
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
    
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: client/package-lock.json
    
      - name: Installation des dÃ©pendances
        run: npm ci
    
      - name: Installer coverage provider
        run: npm install -D @vitest/coverage-v8
    
      - name: VÃ©rifier configuration Vitest
        run: |
          if [ ! -f "vite.config.js" ]; then
            echo "âŒ ERREUR: vite.config.js manquant !"
            echo "CrÃ©ez ce fichier dans client/ avec la configuration Vitest"
            exit 1
          fi
          echo "âœ… vite.config.js trouvÃ©"
          node -c vite.config.js || exit 1
    
      - name: ExÃ©cution des tests Vitest avec coverage
        run: npm run test:coverage
        continue-on-error: false
    
      - name: VÃ©rifier que coverage a Ã©tÃ© gÃ©nÃ©rÃ©
        run: |
          if [ ! -f "coverage/coverage-summary.json" ]; then
            echo "âŒ Fichier coverage-summary.json non trouvÃ© !"
            echo "Contenu du dossier coverage :"
            ls -la coverage/ 2>&1 || echo "Dossier coverage inexistant"
            exit 1
          fi
          echo "âœ… Coverage gÃ©nÃ©rÃ© avec succÃ¨s"
    
      - name: Rapport de coverage dans PR
        if: github.event_name == 'pull_request'
        uses: davelosert/vitest-coverage-report-action@v2
        with:
          working-directory: ./client
          file-coverage-mode: 'changes'
          json-summary-path: './coverage/coverage-summary.json'
          json-final-path: './coverage/coverage-final.json'
          github-token: ${{ secrets.GITHUB_TOKEN }}
    
      - name: Upload rapport coverage HTML
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage-report-${{ matrix.node-version }}
          path: client/coverage/
          retention-days: 7
          overwrite: true
    
      - name: Build de production
        run: npm run build

  # ============================================
  # JOB 3 : VALIDATION BUILD
  # ============================================
  validate-build:
    name: Validation Build Full Stack
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
    
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
    
      - name: Build Backend
        run: |
          cd server
          npm ci
          timeout 10s npm start &
          sleep 5
          echo "âœ… Backend OK"
    
      - name: Build Frontend
        run: |
          cd client
          npm ci
          npm run build
          echo "âœ… Frontend OK"

  # ============================================
  # JOB 4 : RÃ‰SUMÃ‰
  # ============================================
  summary:
    name: RÃ©sumÃ© CI/CD
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, validate-build]
    if: always()
    
    steps:
      - name: GÃ©nÃ©rer rapport
        run: |
          echo "# ðŸ“Š CI/CD Planning Poker" >> $GITHUB_STEP_SUMMARY
          echo "**Statut** : ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branche** : ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY