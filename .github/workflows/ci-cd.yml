name: CI/CD Planning Poker Full Stack

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write

jobs:
  # Job 1 : Tests Backend
  backend-tests:
    name: Backend - Tests et Documentation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./server
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
    
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: server/package-lock.json
    
      - name: Installation des dÃ©pendances
        run: npm ci
    
      - name: ExÃ©cution des tests backend
        run: npm test
    
      - name: GÃ©nÃ©ration coverage backend
        run: npm run test:coverage
    
      - name: GÃ©nÃ©ration documentation JSDoc
        run: npm run docs
    
      - name: Upload documentation backend
        uses: actions/upload-artifact@v4
        with:
          name: backend-docs-${{ matrix.node-version }}
          path: server/docs/
          retention-days: 30
          overwrite: true

  # Job 2 : Tests Frontend
  frontend-tests:
    name: Frontend - Tests Vitest
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./client
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
    
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: client/package-lock.json
    
      - name: Installation des dÃ©pendances
        run: npm ci
    
      - name: VÃ©rifier/crÃ©er la configuration Vitest
        run: |
          # VÃ©rifier si vite.config.js existe dÃ©jÃ 
          if [ -f "vite.config.js" ] || [ -f "vite.config.ts" ]; then
            echo "âœ… Configuration Vite existante trouvÃ©e"
            # VÃ©rifier si la configuration contient les reporters nÃ©cessaires
            if grep -q "json-summary" vite.config.js 2>/dev/null || grep -q "json-summary" vite.config.ts 2>/dev/null; then
              echo "âœ… Reporter 'json-summary' dÃ©jÃ  configurÃ©"
            else
              echo "âš ï¸  Reporter 'json-summary' manquant, mise Ã  jour de la configuration..."
              # CrÃ©er une configuration temporaire pour les tests CI
              cat > vite.config.ci.js << 'EOF'
              import { defineConfig } from 'vite'
              import react from '@vitejs/plugin-react'
              
              export default defineConfig({
                plugins: [react()],
                test: {
                  globals: true,
                  environment: 'jsdom',
                  setupFiles: './src/test/setup.js',
                  coverage: {
                    provider: 'v8',
                    reporter: ['text', 'json-summary', 'json', 'html'],
                    reportsDirectory: './coverage',
                    include: ['src/**/*.{js,jsx,ts,tsx}'],
                    exclude: ['**/*.d.ts', '**/node_modules/**'],
                    reportOnFailure: true,
                    all: true
                  }
                }
              })
              EOF
              export VITE_CONFIG=vite.config.ci.js
            fi
          else
            echo "ðŸ“ CrÃ©ation de vite.config.js pour CI"
            cat > vite.config.js << 'EOF'
            import { defineConfig } from 'vite'
            import react from '@vitejs/plugin-react'
            
            export default defineConfig({
              plugins: [react()],
              test: {
                globals: true,
                environment: 'jsdom',
                setupFiles: './src/test/setup.js',
                coverage: {
                  provider: 'v8',
                  reporter: ['text', 'json-summary', 'json', 'html'],
                  reportsDirectory: './coverage',
                  include: ['src/**/*.{js,jsx,ts,tsx}'],
                  exclude: ['**/*.d.ts', '**/node_modules/**'],
                  reportOnFailure: true,
                  all: true
                }
              }
            })
            EOF
          fi
    
      - name: ExÃ©cution des tests Vitest avec coverage
        # Utiliser --reporter=verbose pour plus d'informations
        run: |
          if [ -f "vite.config.ci.js" ]; then
            echo "ðŸ“Š Utilisation de la configuration CI pour Vitest"
            npx vitest run --config vite.config.ci.js --coverage --reporter=verbose
          else
            npx vitest run --coverage --reporter=verbose
          fi
    
      - name: VÃ©rifier la gÃ©nÃ©ration des rapports de coverage
        run: |
          echo "ðŸ” VÃ©rification des fichiers de coverage gÃ©nÃ©rÃ©s..."
          ls -la coverage/ 2>/dev/null || echo "âŒ Dossier coverage non trouvÃ©"
          
          # VÃ©rifier les fichiers spÃ©cifiques
          if [ -f "coverage/coverage-summary.json" ]; then
            echo "âœ… coverage-summary.json trouvÃ©"
            echo "Contenu du fichier:"
            head -20 coverage/coverage-summary.json
          else
            echo "âŒ coverage-summary.json NON trouvÃ©"
            echo "Liste des fichiers dans coverage/:"
            find coverage/ -type f 2>/dev/null | head -20
          fi
          
          if [ -f "coverage/coverage-final.json" ]; then
            echo "âœ… coverage-final.json trouvÃ©"
          else
            echo "âš ï¸  coverage-final.json non trouvÃ©"
          fi
    
      - name: Upload rapport coverage HTML (toujours exÃ©cuter)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage-${{ matrix.node-version }}
          path: client/coverage/
          retention-days: 7
          overwrite: true
    
      - name: Rapport de coverage dans PR (seulement pour les PRs)
        # Cette Ã©tape ne s'exÃ©cute que sur les pull requests
        if: github.event_name == 'pull_request' && always()
        uses: davelosert/vitest-coverage-report-action@v2
        with:
          working-directory: ./client
          file-coverage-mode: 'all'  # Changer de 'changes' Ã  'all' pour Ã©viter les erreurs
          json-summary-path: './coverage/coverage-summary.json'
          json-final-path: './coverage/coverage-final.json'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          # Options supplÃ©mentaires pour plus de robustesse
          fail-on-error: false
          skip-artifact-upload: true
    
      - name: Build de production
        run: npm run build

  # Job 3 : Validation Build
  validate-build:
    name: Validation Build Full Stack
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
    
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
    
      - name: Build Backend
        run: |
          cd server
          npm ci
          # VÃ©rifie que le serveur peut dÃ©marrer
          timeout 10s npm start &
          sleep 5
          echo "âœ… Backend prÃªt"
    
      - name: Build Frontend
        run: |
          cd client
          npm ci
          npm run build
          echo "âœ… Frontend buildÃ©"

  # Job 4 : DÃ©ploiement Documentation (main seulement)
  deploy-docs:
    name: DÃ©ploiement Documentation
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
    
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
    
      - name: GÃ©nÃ©rer docs backend
        run: |
          cd server
          npm ci
          npm run docs
    
      - name: CrÃ©er site documentation unifiÃ©
        run: |
          mkdir -p public-docs
          
          # Copier docs backend
          if [ -d "server/docs" ]; then
            cp -r server/docs/* public-docs/
            echo "âœ… Documentation backend copiÃ©e"
          else
            echo "âš ï¸  Documentation backend non trouvÃ©e"
          fi
          
          # CrÃ©er une page d'accueil simple
          cat > public-docs/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Planning Poker - Documentation</title>
            <style>
              body { font-family: Arial, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
              h1 { color: #333; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; }
              .card { 
                border: 1px solid #ddd; 
                padding: 20px; 
                margin: 20px 0; 
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
              }
              a { 
                color: #2563eb; 
                text-decoration: none;
                font-weight: bold;
              }
              a:hover { text-decoration: underline; }
              .success { border-left: 4px solid #4CAF50; }
            </style>
          </head>
          <body>
            <h1>ðŸ“š Documentation Planning Poker</h1>
            
            <div class="card success">
              <h2>ðŸ“– Backend Documentation</h2>
              <p>Documentation technique complÃ¨te de l'API et des services backend.</p>
              <p><a href="./index.html">AccÃ©der Ã  la documentation â†’</a></p>
            </div>
            
            <div class="card">
              <h2>ðŸ”— Liens utiles</h2>
              <ul>
                <li><a href="https://github.com/MarteOued/planning-poker">GitHub Repository</a></li>
                <li><a href="https://vitest.dev/">Documentation Vitest</a></li>
                <li><a href="https://expressjs.com/">Documentation Express</a></li>
              </ul>
            </div>
          </body>
          </html>
          EOF
    
      - name: DÃ©ployer sur GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public-docs
          publish_branch: gh-pages
          force_orphan: true

  # Job 5 : RÃ©sumÃ© CI/CD
  summary:
    name: RÃ©sumÃ© CI/CD
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, validate-build]
    if: always()
    
    steps:
      - name: GÃ©nÃ©rer rapport de synthÃ¨se
        run: |
          echo "# ðŸ“Š Rapport CI/CD - Planning Poker" >> $GITHUB_STEP_SUMMARY
          echo "**Date** : $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Branche** : \${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ“‹ RÃ©sumÃ© des jobs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸŸ¢ Backend Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Tests exÃ©cutÃ©s avec Node.js 18.x et 20.x" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation JSDoc gÃ©nÃ©rÃ©e" >> $GITHUB_STEP_SUMMARY
          echo "- Artefacts : backend-docs-*" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸŸ¢ Frontend Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Tests Vitest avec couverture de code" >> $GITHUB_STEP_SUMMARY
          echo "- Rapports de coverage gÃ©nÃ©rÃ©s" >> $GITHUB_STEP_SUMMARY
          echo "- Build de production validÃ©" >> $GITHUB_STEP_SUMMARY
          echo "- Artefacts : frontend-coverage-*" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸŸ¢ Validation Build" >> $GITHUB_STEP_SUMMARY
          echo "- Build backend et frontend vÃ©rifiÃ©s" >> $GITHUB_STEP_SUMMARY
          echo "- Application prÃªte pour le dÃ©ploiement" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ“ˆ Ã‰tapes suivantes" >> $GITHUB_STEP_SUMMARY
          echo "1. TÃ©lÃ©charger les artefacts pour voir les rapports de coverage" >> $GITHUB_STEP_SUMMARY
          echo "2. VÃ©rifier les logs pour dÃ©tecter d'Ã©ventuels warnings" >> $GITHUB_STEP_SUMMARY
          echo "3. Consulter la documentation sur GitHub Pages" >> $GITHUB_STEP_SUMMARY